# 程式交易筆記分享｜回測

大家好，<br>
小弟是一名金融數學專業的碩士生，剛接觸自動化程式交易，並希望學習基於數學和事實的交易策略。我們經常看到來自各種來源的「假先知」，聲稱他們的策略在回測中能以驚人的百分比擊敗市場，但當我們嘗試驗證他們的工作時，發現他們的邏輯存在缺陷，且充滿各種偏差。我決定從 Ernie Chan 的[《Algorithmic Trading - Winning Strategies and Their Rationale》](https://www.google.com/search?gs_ssp=eJzj4tFP1zfMSDfJKDY1KzZg9JJLLcrLTFVIzkjMU0jMSc8vyizJyM1MVigpSkzJzEsHAFyvD-s&q=ernie+chan+algorithmic+trading&rlz=1C5CHFA_enTW990TW990&oq=ernie+chan+&gs_lcrp=EgZjaHJvbWUqBwgCEC4YgAQyBggAEEUYOzIHCAEQLhiABDIHCAIQLhiABDIGCAMQRRg5MgcIBBAAGIAEMgcIBRAAGIAEMgcIBhAAGIAEMgcIBxAuGIAEMgcICBAAGIAE0gEJMTQ4NTVqMGo3qAIAsAIA&sourceid=chrome&ie=UTF-8)著手。這本書包含了許多由個人和專業交易者反覆驗證的有用資訊。
在閱讀這本書的同時，我希望能與大家分享我的筆記，並嘗試將書中的知識應用到我們熟悉的台灣股市裡。Ernie Chan 說，只要具備基礎的微積分、線性代數和統計知識，就能夠輕鬆理解他在書中的討論。但開始閱讀後，我只能說，感謝 Ernie 大哥這麼看好我們！儘管運用這些算法和數學技術可能不需要深入了解背後的工作原理和理論，我們仍應意識到，這些方法和技術對於一般的大學畢業生來說可能超出其知識範圍，除非你的專業是此方面的數學。無論如何，在整理筆記時，我會儘量包括盡可能多的資訊，同時又確保我的筆記易讀又不偏離主題。


由於我希望第一篇文章不僅僅是一些期待和承諾，讓我在這邊從關於研發出自動化交易程式過程中一個重要的部分先貼上我的筆記：回測。

回測是將歷史數據輸入交易策略以檢視其表現的過程。Ernie Chan 在其書籍的第一章中強調了回測的重要性，特別是進行新策略回測時需要考慮的重要事項和常見陷阱。回測的目標是計算預期收益 (Expected Return) 和其他可以反映策略表現的統計指標 (Test Statistic)，同時通過統計方法判斷這些指標的顯著性，從而增加對這些方法在實際交易中是否有效的信心（注意：就算指標很顯著也沒辦法確認他一定會賺錢）。回測中的陷阱和偏差可能會導致回測表現被誇大，與實際表現產生偏差。

回測中常見的陷阱包括以下幾點：

* 前瞻性偏差 (Look ahead Bias)：指在產生當前交易信號時包含了未來的信息。例如，使用當天的最高價或最低價來生成當天的入場信號（任何一天的最高／低價是無法在交易日結束前得知的）。這種問題僅會影響回測，而不會對實際交易造成問題。
* 資料探勘偏差 (Data-Snooping Bias)：資料探勘偏差是由於使用過多的自由參數來擬合過去隨機的市場走勢而導致的，使歷史表現看起來很優秀。基於這些走勢構建的模型往往預測能力較差，因為這些隨機的市場走勢在未來不太可能再次出現。檢測資料探勘偏差可以透過測試策略在樣本外數據上的表現，並剔除那些無法通過測試的模型。一種能夠減少資料探勘偏差的交易策略的方法是使模型盡可能簡單一些，參數越少越好。因此，線性模型通常比非線性模型更可取，少參數比多參數更可取。Ernie 在其書籍第 5 至 7 頁對於資料探勘偏差的討論非常重要，值得一讀。
* 股票拆股和股息調整：如果回測未對股票分割和股息進行調整，由於這些事件引起的價格變化可能會導致錯誤的交易信號。
* 股票資料的生存偏差 (Survivorship Bias)：如果我們的歷史數據中不包含已下市的股票，回測股票交易模型時會遭受生存偏差。想像一個極端情況：假設你的模型建議只購買前一天價格跌幅最大的股票並持有不賣。如果您的歷史數據中沒有包含已下市的股票，那麼回測結果可能非常好，因為數據中的公司都存活了下來了。但現實中，許多經歷劇烈價格下跌的股票可能會破產，導致許多部位損失 100%。該策略在現實中表現很可能會非常糟糕。
* 主要市場價格與綜合價格：在台灣，所有股票都在同一交易所交易，因此對於該市場的交易者而言這不成問題。然而，如果要交易在多個交易所上市的股票，綜合價格可能來自任何一個交易所，而開盤或收盤市價訂單的價格僅來自個人使用的交易所。
* 貨幣報價的市場依賴性：貨幣對價格在不同交易所之間的差異更為明顯，因此回測的真實性取決於使用的歷史數據是否來自於預計交易的同一場地。
* 賣空限制：某些股票由於各種原因可能面臨賣空限制，例如部分股票難以借入，或者在經濟動盪期間聯邦法規可能禁止賣空。如果模型在賣空操作困難或禁止期間包含賣空操作，將導致不切實際的回測回報。台股在歷史上實施四次禁空令，回測時需注意。


除了了解回測過程中的注意事項之外，我們還需要記住，回測本身是一個艱巨且耗時的過程！因此，在盲目地對一個新策略進行回測之前，我們可以考慮參考其他人已經完成的回測，以判斷該策略是否值得投入精力。以下是我們可以注意的一些問題：
* 回撤期：一個回測結果顯示具有長回撤期的策略，即使有很高的年度回報率，也可能伴隨著低Sharpe ratio 。能夠承擔這麼長久回撤的交易者每有幾個，即使該策略具有高年度回報率，也可能是資料探勘偏差的結果，高回報率未必能在未來重現。
* 使用正確的基準：如果一個僅做多原油期貨的策略在 2007 年回報了 20%，Sharpe ratio 為 1.5，檢查 2007 年持有當月原油期貨的總回報發現其回報率為 47%，Sharpe ratio 為 1.7。這表明該策略並不優於簡單的買入並持有。對於純做多的策略，正確的基準應該是Information Ratio，而非 Sharpe ratio。有關 Sharpe ratio、Treynor ratio、Information ratio，[看這裡](https://stockmarketconcepts.weebly.com/difference-between-sharpe-ratio-treynor-ratio-and-information-ratio.html)。
* 買低賣高的策略：應檢查該回測使用的數據庫是否沒有生存者偏差。
* 參數過多的模型：一個參數過多的模型容易受到資料探勘偏差的影響，對未來的預測能力可能很弱。
* 高頻交易策略：高頻交易策略的收益很大程度上取決於其他市場參與者的反應。這並不是說高頻交易策略無效，但下單或執行訂單的行為可能會改變其他市場參與者的行為。回測無法模擬這些動態。

以上就是我對回測的重點整理，供各位前輩參考！在未來的日子裡，我希望照著書本中的內容學習並發展出一些實作。這些實作會包含一些 Fugle API 的使用教學。敬請期待！如果有任何問題或建議，歡迎留言。

